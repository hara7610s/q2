<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¦ã‚§ãƒ‡ã‚£ãƒ³ã‚°ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ ğŸ‡ã‚µãƒ³ãƒ¬ãƒ³ã‚¿ãƒ³ğŸ‡ï½œé¦¬åˆ¸æŠ•ç¥¨ãƒšãƒ¼ã‚¸</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Outfit:wght@400;600;800&display=swap"
    rel="stylesheet">
  <style>
    :root {
      /* Modern Palette */
      --bg-gradient: linear-gradient(135deg, #fdfbf7 0%, #f4f7f6 100%);
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border: rgba(255, 255, 255, 0.5);
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);

      --ink: #1e293b;
      --muted: #64748b;
      --primary: #0f766e;
      /* Teal-ish for wedding vibe */
      --primary-dark: #0d5f58;
      --accent: #d97706;
      /* Gold-ish */
      --focus-ring: rgba(15, 118, 110, 0.3);

      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg-gradient);
      color: var(--ink);
      font-family: 'Outfit', 'Noto Sans JP', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .wrap {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    p.lead {
      color: var(--muted);
      margin: 0 0 32px;
      text-align: left;
      font-size: 15px;
      font-weight: 500;
      line-height: 1.6;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow-md);
      margin-bottom: 24px;
      transition: transform 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    @media(min-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr 1fr;
      }

      .full-width {
        grid-column: 1 / -1;
      }
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.02em;
    }

    input,
    select {
      width: 100%;
      background: #fff;
      color: var(--ink);
      border: 1px solid #e2e8f0;
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.2s;
      appearance: none;
    }

    /* Custom arrow for select */
    .select-wrapper {
      position: relative;
    }

    .select-wrapper::after {
      content: '';
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 6px;
      background-color: var(--muted);
      clip-path: polygon(0 0, 100% 0, 50% 100%);
      pointer-events: none;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--focus-ring);
    }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 14px 24px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 6px -1px rgba(15, 118, 110, 0.2);
      min-width: 120px;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 8px -1px rgba(15, 118, 110, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.ghost {
      background: transparent;
      border: 2px solid #e2e8f0;
      color: var(--muted);
      box-shadow: none;
    }

    .btn.ghost:hover {
      border-color: var(--muted);
      color: var(--ink);
      background: #f8fafc;
    }

    .btn.accent {
      background: linear-gradient(135deg, var(--accent) 0%, #b45309 100%);
      box-shadow: 0 4px 6px -1px rgba(217, 119, 6, 0.2);
    }

    .btn.accent:hover {
      box-shadow: 0 6px 8px -1px rgba(217, 119, 6, 0.3);
    }

    .tips {
      font-size: 13px;
      color: var(--muted);
      margin-left: 8px;
    }

    canvas {
      width: 100%;
      max-width: 100%;
      display: block;
      height: auto;
      border-radius: 0;
      border: 1px solid #e2e8f0;
      background: #fff;
      box-shadow: var(--shadow-sm);
    }

    @media (max-width: 640px) {
      body {
        padding: 16px;
      }

      .card {
        padding: 20px;
      }
    }

    h3 {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 16px;
      color: var(--ink);
    }
  </style>
  <!-- ä»»æ„ï¼šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ã®å›ºå®šãƒ™ãƒ¼ã‚¹ç”»åƒï¼‰ -->
  <link rel="preload" as="image" href="img/test.png">
</head>

<body>
  <div class="wrap">
    <h1>ã‚¦ã‚§ãƒ‡ã‚£ãƒ³ã‚°ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼<br>ğŸ‡ã‚µãƒ³ãƒ¬ãƒ³ã‚¿ãƒ³ğŸ‡<br>é¦¬åˆ¸æŠ•ç¥¨ãƒšãƒ¼ã‚¸</h1>
    <p class="lead">ç¬¬1å•<br>æ–°éƒãŒã‹ã‚ã„ã„ã¨è¨€ã†ã¨æ–°å©¦ãŒå«‰å¦¬ã™ã‚‹å¥³æ€§èŠ¸èƒ½äººã¯ï¼Ÿ</p>

    <div class="card">
      <form id="quizForm" onsubmit="return false;" class="form-grid">
        <div class="input-group full-width">
          <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
          <input id="nickname" placeholder="ä¾‹: ã¯ã‚‰ã" />
        </div>
        <div class="input-group">
          <label>1ä½ äºˆæƒ³</label>
          <div class="select-wrapper">
            <select id="pick1" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option>1&nbsp;&nbsp;&nbsp;&nbsp;å‰å²¡é‡Œå¸†</option>
              <option>2&nbsp;&nbsp;&nbsp;&nbsp;ä¸­æ¡ã‚ã‚„ã¿</option>
              <option>3&nbsp;&nbsp;&nbsp;&nbsp;å¤šéƒ¨æœªè¯å­</option>
              <option>4&nbsp;&nbsp;&nbsp;&nbsp;å±±ç”°æå¥ˆ</option>
              <option>5&nbsp;&nbsp;&nbsp;&nbsp;å¹¾ç”°ã‚Šã‚‰</option>
              <option>6&nbsp;&nbsp;&nbsp;&nbsp;ã‚ã®</option>
              <option>7&nbsp;&nbsp;&nbsp;&nbsp;ãƒ©ãƒ©ãƒ³ãƒ‰ã‚µãƒ¼ãƒ¤</option>
            </select>
          </div>
        </div>
        <div class="input-group">
          <label>2ä½ äºˆæƒ³</label>
          <div class="select-wrapper">
            <select id="pick2" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option>1&nbsp;&nbsp;&nbsp;&nbsp;å‰å²¡é‡Œå¸†</option>
              <option>2&nbsp;&nbsp;&nbsp;&nbsp;ä¸­æ¡ã‚ã‚„ã¿</option>
              <option>3&nbsp;&nbsp;&nbsp;&nbsp;å¤šéƒ¨æœªè¯å­</option>
              <option>4&nbsp;&nbsp;&nbsp;&nbsp;å±±ç”°æå¥ˆ</option>
              <option>5&nbsp;&nbsp;&nbsp;&nbsp;å¹¾ç”°ã‚Šã‚‰</option>
              <option>6&nbsp;&nbsp;&nbsp;&nbsp;ã‚ã®</option>
              <option>7&nbsp;&nbsp;&nbsp;&nbsp;ãƒ©ãƒ©ãƒ³ãƒ‰ã‚µãƒ¼ãƒ¤</option>
            </select>
          </div>
        </div>
        <div class="input-group">
          <label>3ä½ äºˆæƒ³</label>
          <div class="select-wrapper">
            <select id="pick3">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option>1&nbsp;&nbsp;&nbsp;&nbsp;å‰å²¡é‡Œå¸†</option>
              <option>2&nbsp;&nbsp;&nbsp;&nbsp;ä¸­æ¡ã‚ã‚„ã¿</option>
              <option>3&nbsp;&nbsp;&nbsp;&nbsp;å¤šéƒ¨æœªè¯å­</option>
              <option>4&nbsp;&nbsp;&nbsp;&nbsp;å±±ç”°æå¥ˆ</option>
              <option>5&nbsp;&nbsp;&nbsp;&nbsp;å¹¾ç”°ã‚Šã‚‰</option>
              <option>6&nbsp;&nbsp;&nbsp;&nbsp;ã‚ã®</option>
              <option>7&nbsp;&nbsp;&nbsp;&nbsp;ãƒ©ãƒ©ãƒ³ãƒ‰ã‚µãƒ¼ãƒ¤</option>
            </select>
          </div>
        </div>
        <div class="actions full-width">
          <button class="btn" id="submitBtn">é¦¬åˆ¸ç™ºè¡Œ</button>
          <!-- ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³å‰Šé™¤ -->
          <button id="copyBtn" type="button" class="btn ghost">ç”»åƒã‚’ã‚³ãƒ”ãƒ¼</button>
          <span id="status" class="tips"></span>
        </div>
      </form>
    </div>

    <div class="card">
      <h3>é¦¬åˆ¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <canvas id="ticket" width="850" height="530" aria-label="é¦¬åˆ¸"></canvas>
    </div>

    <div style="text-align: right; margin-bottom: 40px;">
      <button id="nextBtn" class="btn accent">ç¬¬2å•ã¯ã“ã¡ã‚‰</button>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const canvas = $('#ticket');
    const ctx = canvas.getContext('2d');

    // å›ºå®šãƒ™ãƒ¼ã‚¹ç”»åƒã®è¨­å®š
    const BASE_IMAGE_URL = 'img/test.png'; // ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ç›¸å¯¾ãƒ‘ã‚¹
    const BASE_FIT = 'cover';              // 'cover' or 'contain'

    // æ˜ã‚‹ã„ãƒ‘ãƒ¬ãƒƒãƒˆ
    const theme = { bg: '#f7fbff', panel: '#ffffff', ink: '#0f172a', sub: '#475569', accent: '#16a34a', line: '#e2e8f0', subtle: '#f1f5f9', race: '#0ea5e9' };

    const pad = (n) => String(n).padStart(2, '0');
    const formatTs = (d) => `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    const trunc = (s, n) => !s ? s : (s.length > n ? s.slice(0, n - 1) + 'â€¦' : s);

    let baseImg = null; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥

    function loadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        // åŒä¸€ã‚ªãƒªã‚¸ãƒ³æƒ³å®šï¼ˆGitHub Pages/Netlifyãªã©ï¼‰ã€‚CORSä¸è¦ã€‚
        img.onload = () => resolve(img);
        img.onerror = (e) => reject(e);
        img.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ‘ã‚¹
      });
    }

    function drawFittedImage(img, fit) {
      const W = canvas.width, H = canvas.height;
      const ir = img.width / img.height; const cr = W / H;
      let dw, dh, dx, dy;
      if (fit === 'contain') {
        const ratio = cr > ir ? H / img.height : W / img.width;
        dw = Math.round(img.width * ratio); dh = Math.round(img.height * ratio);
        dx = Math.round((W - dw) / 2); dy = Math.round((H - dh) / 2);
      } else { // cover
        const ratio = cr > ir ? W / img.width : H / img.height;
        dw = Math.round(img.width * ratio); dh = Math.round(img.height * ratio);
        dx = Math.round((W - dw) / 2); dy = Math.round((H - dh) / 2);
      }
      ctx.drawImage(img, dx, dy, dw, dh);
    }

    function lightBand(x, y, w, h) {
      const g = ctx.createLinearGradient(x, y, x + w, y);
      g.addColorStop(0, '#e0f2fe'); g.addColorStop(0.55, '#bae6fd'); g.addColorStop(1, '#bbf7d0');
      ctx.fillStyle = g; ctx.fillRect(x, y, w, h);
    }

    function roundRect(x, y, w, h, r, fill = true) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      if (fill) ctx.fill();
      ctx.strokeStyle = theme.line; ctx.lineWidth = 1; ctx.stroke();
    }

    function labelText(text, x, y, color) { ctx.fillStyle = color || theme.ink; ctx.fillText(text, x, y); }
    function blockTitle(text, x, y) { ctx.save(); ctx.shadowColor = 'rgba(255,255,255,0.8)'; ctx.shadowBlur = 6; ctx.fillStyle = theme.ink; ctx.fillText(text, x, y); ctx.restore(); }

    async function ensureBase() {
      if (baseImg) return baseImg;
      try { baseImg = await loadImage(BASE_IMAGE_URL); }
      catch (e) { console.warn('ãƒ™ãƒ¼ã‚¹ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—', e); baseImg = null; }
      return baseImg;
    }

    async function drawTicket(data) {
      const W = canvas.width, H = canvas.height;

      // èƒŒæ™¯ï¼ˆå›ºå®šãƒ™ãƒ¼ã‚¹ or ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      ctx.fillStyle = theme.bg; ctx.fillRect(0, 0, W, H);
      const img = await ensureBase();
      if (img) { drawFittedImage(img, BASE_FIT); }
      else { // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ˜ã‚‹ã„å¸¯ï¼‹ç™½é¢
        ctx.fillStyle = '#ffffff'; roundRect(24, 24, W - 48, H - 48, 24, true); lightBand(40, 60, W - 80, 90);
      }

      // é †ä½
      const picks = [data.pick1, data.pick2, data.pick3].filter(Boolean);
      const baseY = 103;
      picks.forEach((p, i) => {
        const y = baseY + i * 157;
        ctx.fillStyle = theme.ink; ctx.font = '700 48px system-ui, "Noto Sans JP"'; labelText(p, 432, y, theme.ink);
      });

      // ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆIDãƒ»ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ»ç™ºè¡Œæ™‚åˆ»ï¼‰
      const issuedAt = data.issuedAt ? new Date(data.issuedAt) : new Date();
      ctx.font = '700 16px system-ui'; ctx.fillStyle = theme.ink; labelText(trunc(data.nickname || 'â€”', 18), 400, H - 20, theme.ink); labelText(data.answerId, 500, H - 20, theme.ink); labelText(formatTs(issuedAt), 650, H - 20, theme.ink);

      // DLãƒªãƒ³ã‚¯ã¨ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰
      const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.95));
      // ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³å‰Šé™¤ã«ä¼´ã„ã€DLãƒªãƒ³ã‚¯å‡¦ç†ã‚‚å‰Šé™¤
      $('#copyBtn').onclick = async () => { try { const item = new ClipboardItem({ 'image/png': blob }); await navigator.clipboard.write([item]); $('#status').textContent = 'ç”»åƒã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'; } catch (e) { $('#status').textContent = 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã®å¯èƒ½æ€§ï¼‰ã€‚'; } };
    }

    function genAnswerId() { return 'Q' + Date.now().toString(36).toUpperCase(); }

    const GAS_URL = "https://script.google.com/macros/s/AKfycbzxiXJh5jpfM2Ey4d_NnZDFd3V1MBJJcqqbV1MPlVE-8QrYk3547Zn78DPJxVNSLO5W/exec";

    async function onSubmit() {
      const data = {
        nickname: $('#nickname').value.trim(),
        pick1: $('#pick1').value.trim(),
        pick2: $('#pick2').value.trim(),
        pick3: $('#pick3').value.trim(),
        answerId: genAnswerId(),
        issuedAt: Date.now()
      };
      if (!data.pick1 || !data.pick2 || !data.pick3) {
        $('#status').textContent = 'ãƒ¬ãƒ¼ã‚¹åã¨1ã€œ3ä½ã¯å¿…é ˆã§ã™ã€‚'; return;
      }
      // ç”»åƒç™ºè¡Œ
      await drawTicket(data);

      // â˜… å›ç­”ã‚’GASã¸é€ä¿¡ï¼ˆé›†è¨ˆç”¨ï¼‰
      try {
        await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            ts: data.issuedAt,
            nickname: data.nickname,
            pick1: data.pick1,
            pick2: data.pick2,
            pick3: data.pick3,
            answerId: data.answerId
          })
        });
        $('#status').textContent = 'é¦¬åˆ¸ç™ºè¡Œï¼†æŠ•ç¥¨å†…å®¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚';
      } catch (e) {
        $('#status').textContent = 'é¦¬åˆ¸ç™ºè¡Œï¼†æŠ•ç¥¨å†…å®¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚';
      }
    }

    $('#submitBtn').addEventListener('click', onSubmit);

    // ç¬¬2å•ã¸é·ç§»
    $('#nextBtn').addEventListener('click', () => {
      if (confirm('ç¬¬2å•ã¸ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) {
        window.location.href = 'https://hara7610s.github.io/q2/';
      }
    });

    // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    (async () => {
      await ensureBase();
    })();
  </script>
</body>

</html>